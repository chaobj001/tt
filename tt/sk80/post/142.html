<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="利用PHP制作简单的内容采集器:PHP,PHP 采集 " /><meta name="description" content="利用PHP制作简单的内容采集器,php 小偷程序的一些笔记,php小偷程序原理" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>利用PHP制作简单的内容采集器</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/php/">PHP</a>&gt;<strong class="current">利用PHP制作简单的内容采集器</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="php 小偷程序的一些笔记" href="http://sk2.com/post/143.html" rel="nofollow">Newer</a></li><li class="older"><a title="php小偷程序原理" href="http://sk2.com/post/141.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>利用PHP制作简单的内容采集器</h1><ul class="info"><li class="date">2010年 03月27日  12:20</li><li class="category"><a href="http://sk2.com/category/php/">PHP</a></li></ul><div class="textbody">采集器，通常又叫小偷程序，主要是用来抓取别人网页内容的。关于采集器的制作，其实并不难，就是远程打开要采集的网页，然后用正则表达式将需要的内容匹配出来，只要稍微有点正则表达式的基础，都能做出自己的采集器来的。 <br />　　前几天做了个小说连载的程序，因为怕更新麻烦，顺带就写了个采集器，采集八路中文网的，功能比较简单，不能自定义规则，不过大概思路都在里面了，自定义规则可以自己来扩展。 <br />　　用php来做采集器主要用到两个函数：file_get_contents()和preg_match_all()，前一个是远程读取网页内容的，不过只在php5以上的版本才能用，后一个是正则函数，用来提取需要的内容的。 <br />　　下面就一步一步来讲功能实现。 <br />　　因为是采集小说，所以首先要将书名、作者、类型这三个提取出来，别的信息可根据需要提取。<br />　　这里以《回到明朝当王爷》为目标，先打开书目页，链接：http://www.86zw.com/Book/3727/Index.aspx<br />　　多打开几本书会发现，书名的基本格式是：http://www.86zw.com/Book/书号/Index.aspx，于是我们可以做一个开始页，定义一个&lt;input type=text name=number&gt;，用来输入需要采集的书号，以后就可以通过$_POST[‘number’]这种格式来接收需要采集的书号了。接收到书号，下面要做的就是构造书目页：$url=http://www.86zw.com/Book/$_POST[‘number’]/Index.aspx，当然这里是举个例子，主要是为了讲解方便，实际制作的时候最好检查一下$_POST[‘number’]的合法性。 <br />　　构造好URL以后就可以开始采集书籍信息了。使用file_get_contents() 函数打开书目页：$content=file_get_contents（$url），这样就能将书目页的内容都读取出来了。接下来就是将书名、作者和类型等信息匹配出来了。这里就以书名为例，其他的都一样。 打开书目页，查看源文件，找到“&lt;span class="booktitle"&gt;《回到明朝当王爷》&lt;/span&gt;”，这就是要提取出来的书名了。提取书名的正则表达式：/&amp;lt;span class=\"newstitle\"&gt;(.*?)\&lt;\/span&gt;/is，使用preg_match_all()函数将书名取出：preg_match_all("/&lt;span class=\"newstitle\"&gt;(.*?)\&lt;\/span&gt;/is",$contents,$title);这样$title[0][0]的内容就是我们要的标题了（preg_match_all函数的用法可以去百度查，这里就不详细说明了）。取出了书籍信息，接下来就是取章节内容了，要取章节内容，首先要做的就是找到每一章的地址，然后远程打开章节，用正则将内容取出来，入库或者直接生成html静态文件。这个是章节列表的地址：http://www.86zw.com/Html/Book/18/3727/List.shtm，可以看出这个和书目页一样，是有规律可寻的：http://www.86zw.com/Html/Book/分类号/书号/List.shtm。书号前面已经取得，这里的关键是找到分类号，分类号可以在前面的书目页找到，提取分类号：<br />　　preg_match_all("/Html\/Book\/[0-9]{1,}\/[0-9]{1,}\/List\.shtm/is",$contents,$typeid);这样还不够，还需要一个切取函数：<p><br /><div class="code"><pre class="php" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;"><span style="color: #000000; font-weight: bold;">function</span> cut<span style="color: #009900;">&#40;</span><span style="color: #000088;">$string</span><span style="color: #339933;">,</span><span style="color: #000088;">$start</span><span style="color: #339933;">,</span><span style="color: #000088;">$end</span><span style="color: #009900;">&#41;</span><span style="color: #009900;">&#123;</span>  
<span style="color: #000088;">$message</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/explode"><span style="color: #990000;">explode</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$start</span><span style="color: #339933;">,</span><span style="color: #000088;">$string</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$message</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/explode"><span style="color: #990000;">explode</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$end</span><span style="color: #339933;">,</span><span style="color: #000088;">$message</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #b1b100;">return</span> <span style="color: #000088;">$message</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span><span style="color: #009900;">&#125;</span></pre></div></p><p>其中$string为要被切取的内容，$start为开始的地方，$end为结束的地方。取出分类号：</p><p><div class="code"><pre class="php" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;"><span style="color: #000088;">$start</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;Html/Book/&quot;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$end</span><span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;List.shtm&quot;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$typeid</span> <span style="color: #339933;">=</span> cut<span style="color: #009900;">&#40;</span><span style="color: #000088;">$typeid</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span><span style="color: #000088;">$start</span><span style="color: #339933;">,</span><span style="color: #000088;">$end</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$typeid</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/explode"><span style="color: #990000;">explode</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;/&quot;</span><span style="color: #339933;">,</span><span style="color: #000088;">$typeid</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span></pre></div></p><p>这样，$typeid[0]就是我们要找的分类号了。接下来就是构造章节列表的地址了：$chapterurl = http://www.86zw.com/Html/Book/.$typeid[0]/$_POST[‘number’]/List.shtm。有了这个就能找到每一章节的地址了。方法如下：</p><p><div class="code"><pre class="php" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;"><span style="color: #000088;">$ustart</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\&quot;</span>&quot;</span><span style="color: #339933;">;</span>   
<span style="color: #000088;">$uend</span> 
<span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;<span style="color: #000099; font-weight: bold;">\&quot;</span>&quot;</span><span style="color: #339933;">;</span>   
<span style="color: #666666; font-style: italic;">//t表示title的缩写  </span>
<span style="color: #000088;">$tstart</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;&gt;&quot;</span><span style="color: #339933;">;</span>   
<span style="color: #000088;">$tend</span> 
<span style="color: #339933;">=</span> <span style="color: #0000ff;">&quot;&lt;&quot;</span><span style="color: #339933;">;</span>   
<span style="color: #666666; font-style: italic;">//取路径,例如:123.shtm,2342.shtm,233.shtm  </span>
<a href="http://www.php.net/preg_match_all"><span style="color: #990000;">preg_match_all</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;/<span style="color: #000099; font-weight: bold;">\&quot;</span>[0-9]{1,}\.(shtm)<span style="color: #000099; font-weight: bold;">\&quot;</span>/is&quot;</span><span style="color: #339933;">,</span><span style="color: #000088;">$chapterurl</span><span style="color: #339933;">,</span><span style="color: #000088;">$url</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>   
<span style="color: #666666; font-style: italic;">//取标题,例如:第一章 九世善人  </span>
<a href="http://www.php.net/preg_match_all"><span style="color: #990000;">preg_match_all</span></a><span style="color: #009900;">&#40;</span><span style="color: #0000ff;">&quot;/&lt;a href=<span style="color: #000099; font-weight: bold;">\&quot;</span>[0-9]{1,}\.shtm<span style="color: #000099; font-weight: bold;">\&quot;</span>(.*?)\&lt;\/a&gt;/is&quot;</span><span style="color: #339933;">,</span><span style="color: #000088;">$file</span><span style="color: #339933;">,</span><span style="color: #000088;">$title</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>   
<span style="color: #000088;">$count</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/count"><span style="color: #990000;">count</span></a><span style="color: #009900;">&#40;</span><span style="color: #000088;">$url</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #b1b100;">for</span><span style="color: #009900;">&#40;</span><span style="color: #000088;">$i</span><span style="color: #339933;">=</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">;</span><span style="color: #000088;">$i</span><span style="color: #339933;">&lt;=</span><span style="color: #000088;">$count</span><span style="color: #339933;">;</span><span style="color: #000088;">$i</span><span style="color: #339933;">++</span><span style="color: #009900;">&#41;</span>  
<span style="color: #009900;">&#123;</span>  
<span style="color: #000088;">$u</span> <span style="color: #339933;">=</span> cut<span style="color: #009900;">&#40;</span><span style="color: #000088;">$url</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$i</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span><span style="color: #000088;">$ustart</span><span style="color: #339933;">,</span><span style="color: #000088;">$uend</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$t</span> <span style="color: #339933;">=</span> cut<span style="color: #009900;">&#40;</span><span style="color: #000088;">$title</span><span style="color: #009900;">&#91;</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$i</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span><span style="color: #000088;">$tstart</span><span style="color: #339933;">,</span><span style="color: #000088;">$tend</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>  
<span style="color: #000088;">$array</span><span style="color: #009900;">&#91;</span><span style="color: #000088;">$u</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$t</span><span style="color: #339933;">;</span>  
<span style="color: #009900;">&#125;</span></pre></div></p><p>$array数组就是所有的章节地址了，到这里，采集器就完成一半了，剩下的就是循环打开每个章节地址，读取，然后将内容匹配出来。这个比较简单，这里就不详细叙述了。好了，今天就先写到这吧，第一次写这么长的文章，语言组织方面难免有问题，还请大家多包涵！</p></div><div class="entry-tags"><strong>Tags:</strong><a href="http://sk2.com/tag/PHP/">PHP</a>,<a href="http://sk2.com/tag/采集/">采集</a></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/143.html">php 小偷程序的一些笔记</a></li><li>Older:<a href="http://sk2.com/post/141.html">php小偷程序原理</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>