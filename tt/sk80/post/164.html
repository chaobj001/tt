<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="Mysql参数配置优化说明:Linux," /><meta name="description" content="Mysql参数配置优化说明,JQuery 常用插件,Linux网卡配置" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>Mysql参数配置优化说明</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/linux/">Linux</a>&gt;<strong class="current">Mysql参数配置优化说明</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="JQuery 常用插件" href="http://sk2.com/post/165.html" rel="nofollow">Newer</a></li><li class="older"><a title="Linux网卡配置" href="http://sk2.com/post/163.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>Mysql参数配置优化说明</h1><ul class="info"><li class="date">2010年 03月28日  23:41</li><li class="category"><a href="http://sk2.com/category/linux/">Linux</a></li></ul><div class="textbody"><p><strong>1．获取当前配置参数</strong></p><p>要优化配置参数，首先要了解当前的配置参数以及运行情况。使用下列命令可以获得目前服务器使用的配置参数：<br /><span style="color: rgb(51, 153, 102);">mysqld –verbose –help<br />mysqladmin variables extended-status –u root –p</span></p><p>在MySQL控制台里面，运行下列命令可以获取状态变量的值：<br /><span style="color: rgb(51, 153, 102);">mysql&gt; SHOW STATUS;</span></p><p>如果只要检查某几个状态变量，可以使用下列命令：<br /><span style="color: rgb(51, 153, 102);">mysql&gt; SHOW STATUS LIKE ‘[匹配模式]’; </span>( 可以使用%、?等 )</p><p><strong>2．优化参数</strong></p><p>参数优化基于一个前提，就是在我们的数据库中通常都使用InnoDB表，而不使用MyISAM表。在优化MySQL时，有两个配置参数是最重要的，即<span style="color: rgb(0, 255, 0);">table_cache</span>和<span style="color: rgb(0, 255, 0);">key_buffer_size</span>。</p><p><strong>table_cache</strong><br /><span style="color: rgb(0, 255, 0);">table_cache</span>指定表高速缓存的大小。每当MySQL访问一个表时，如果在表缓冲区中还有空间，该表就被打开并放入其中，这样可以更快地访问表内容。通过检查峰值时间的状态值<span style="color: rgb(0, 255, 0);">Open_tables</span>和<span style="color: rgb(0, 255, 0);">Opened_tables</span>，可以决定是否需要增加<span style="color: rgb(0, 255, 0);">table_cache</span>的值。如果你发现<span style="color: rgb(0, 255, 0);">open_tables</span>等于<span style="color: rgb(0, 255, 0);">table_cache</span>，并且<span style="color: rgb(0, 255, 0);">opened_tables</span>在不断增长，那么你就需要增加<span style="color: rgb(0, 255, 0);">table_cache</span>的值了（上述状态值可以使用<span style="color: rgb(51, 153, 102);">SHOW STATUS LIKE ‘Open%tables’</span>获得）。注意，不能盲目地把<span style="color: rgb(0, 255, 0);">table_cache</span>设置成很大的值。如果设置得太高，可能会造成文件描述符不足，从而造成性能不稳定或者连接失败。</p><p>对于有1G内存的机器，推荐值是128－256。</p><p>案例1：该案例来自一个不是特别繁忙的服务器<br /><span style="color: rgb(0, 255, 0);">table_cache – 512<br />open_tables – 103<br />opened_tables – 1273<br />uptime – 4021421 (measured in seconds)</span><br />该案例中table_cache似乎设置得太高了。在峰值时间，打开表的数目比table_cache要少得多。<br />案例2：该案例来自一台开发服务器。<br /><span style="color: rgb(0, 255, 0);">table_cache – 64<br />open_tables – 64<br />opened-tables – 431<br />uptime – 1662790 (measured in seconds)</span><br />虽然<span style="color: rgb(0, 255, 0);">open_tables</span>已经等于<span style="color: rgb(0, 255, 0);">table_cache</span>，但是相对于服务器运行时间来说，<span style="color: rgb(0, 255, 0);">opened_tables</span>的值也非常低。因此，增加<span style="color: rgb(0, 255, 0);">table_cache</span>的值应该用处不大。<br />案例3：该案例来自一个性能不佳的服务器<br /><span style="color: rgb(0, 255, 0);">table_cache – 64<br />open_tables – 64<br />opened_tables – 22423<br />uptime – 19538</span><br />该案例中<span style="color: rgb(0, 255, 0);">table_cache</span>设置得太低了。虽然运行时间不到6小时，<span style="color: rgb(0, 255, 0);">open_tables</span>达到了最大值，<span style="color: rgb(0, 255, 0);">opened_tables</span>的值也非常高。这样就需要增加<span style="color: rgb(0, 255, 0);">table_cache</span>的值。</p><p><strong>key_buffer_size</strong><br /><span style="color: rgb(0, 255, 0);">key_buffer_size</span>指定索引缓冲区的大小，它决定索引处理的速度，尤其是索引读的速度。通过检查状态值<span style="color: rgb(0, 255, 0);">Key_read_requests</span>和<span style="color: rgb(0, 255, 0);">Key_reads</span>，可以知道key_buffer_size设置是否合理。比例key_reads / key_read_requests应该尽可能的低，至少是1:100，1:1000更好（上述状态值可以使用<span style="color: rgb(51, 153, 102);">SHOW STATUS LIKE ‘key_read%’</span>获得）。</p><p>key_buffer_size只对MyISAM表起作用。即使你不使用MyISAM表，但是内部的临时磁盘表是MyISAM表，也要使用该值。可以使用检查状态值created_tmp_disk_tables得知详情。</p><p>对于1G内存的机器，如果不使用MyISAM表，推荐值是16M（8-64M）。</p><p>案例1：健康状况<br /><span style="color: rgb(0, 255, 0);">key_buffer_size – 402649088 (384M)<br />key_read_requests – 597579931<br />key_reads - 56188</span><br />案例2：警报状态<br /><span style="color: rgb(0, 255, 0);">key_buffer_size – 16777216 (16M)<br />key_read_requests – 597579931<br />key_reads - 53832731</span><br />案例1中比例低于1:10000，是健康的情况；案例2中比例达到1:11，警报已经拉响。</p><p><strong>query_cache_size</strong><br />从4.0.1开始，MySQL提供了查询缓冲机制。使用查询缓冲，MySQL将SELECT语句和查询结果存放在缓冲区中，今后对于同样的SELECT语句（区分大小写），将直接从缓冲区中读取结果。根据MySQL用户手册，使用查询缓冲最多可以达到238％的效率。<br />通过检查状态值Qcache_*，可以知道<span style="color: rgb(0, 255, 0);">query_cache_size</span>设置是否合理（上述状态值可以使用<span style="color: rgb(51, 153, 102);">SHOW STATUS LIKE ‘Qcache%’</span>获得）。如果<span style="color: rgb(0, 255, 0);">Qcache_lowmem_prunes</span>的值非常大，则表明经常出现缓冲不够的情况，如果<span style="color: rgb(0, 255, 0);">Qcache_hits</span>的值也非常大，则表明查询缓冲使用非常频繁，此时需要增加缓冲大小；如果<span style="color: rgb(0, 255, 0);">Qcache_hits</span>的值不大，则表明你的查询重复率很低，这种情况下使用查询缓冲反而会影响效率，那么可以考虑不用查询缓冲。此外，在SELECT语句中加入<span style="color: rgb(51, 153, 102);">SQL_NO_CACHE</span>可以明确表示不使用查询缓冲。<br />与查询缓冲有关的参数还有<span style="color: rgb(0, 255, 0);">query_cache_type、query_cache_limit、query_cache_min_res_unit。query_cache_type</span>指定是否使用查询缓冲，可以设置为0、1、2，该变量是SESSION级的变量。query_cache_limit指定单个查询能够使用的缓冲区大小，缺省为1M。<span style="color: rgb(0, 255, 0);">query_cache_min_res_unit</span>是在4.1版本以后引入的，它指定分配缓冲区空间的最小单位，缺省为4K。检查状态值<span style="color: rgb(0, 255, 0);">Qcache_free_blocks</span>，如果该值非常大，则表明缓冲区中碎片很多，这就表明查询结果都比较小，此时需要减小<span style="color: rgb(0, 255, 0);">query_cache_min_res_unit</span>。</p><p><strong>开启二进制日志( Binary Log )</strong><br />二进制日志包含所有更新数据的语句，其目的是在恢复数据库时用它来把数据尽可能恢复到最后的状态。另外，如果做同步复制( Replication )的话，也需要使用二进制日志传送修改情况。<br />开启二进制日志，需要设置参数log-bin。log_bin指定日志文件，如果不提供文件名，MySQL将自己产生缺省文件名。MySQL会在文件名后面自动添加数字索引，每次启动服务时，都会重新生成一个新的二进制文件。<br />此外，使用log-bin-index可以指定索引文件；使用binlog-do-db可以指定记录的数据库；使用binlog-ignore-db可以指定不记录的数据库。注意的是：binlog-do-db和binlog-ignore-db一次只指定一个数据库，指定多个数据库需要多个语句。而且，MySQL会将所有的数据库名称改成小写，在指定数据库时必须全部使用小写名字，否则不会起作用。<br />在MySQL中使用<span style="color: rgb(51, 153, 102);">SHOW MASTER STATUS</span>命令可以查看目前的二进制日志状态。</p><p><strong>开启慢查询日志( slow query log )</strong><br />慢查询日志对于跟踪有问题的查询非常有用。它记录所有查过long_query_time的查询，如果需要，还可以记录不使用索引的记录。下面是一个慢查询日志的例子：<br />开启慢查询日志，需要设置参数<span style="color: rgb(0, 255, 0);">log_slow_queries、long_query_times、log-queries-not-using-indexes</span>。<span style="color: rgb(0, 255, 0);">log_slow_queries</span>指定日志文件，如果不提供文件名，MySQL将自己产生缺省文件名。long_query_times指定慢查询的阈值，缺省是10秒。<span style="color: rgb(0, 255, 0);">log-queries-not-using-indexes</span>是4.1.0以后引入的参数，它指示记录不使用索引的查询。</p><p><strong>配置InnoDB</strong><br />相对于MyISAM表来说，正确配置参数对于InnoDB表更加关键。其中，最重要的参数是innodb_data_file_path。它指定表数据和索引存储的空间，可以是一个或者多个文件。最后一个数据文件必须是自动扩充的，也只有最后一个文件允许自动扩充。这样，当空间用完后，自动扩充数据文件就会自动增长（以8MB为单位）以容纳额外的数据。例如：<br /><span style="color: rgb(0, 255, 0);">innodb_data_file_path=/disk1/ibdata1:900M;/disk2/ibdata2:50M:autoextend</span></p><p>两个数据文件放在不同的磁盘上。数据首先放在ibdata1中，当达到900M以后，数据就放在ibdata2中。一旦达到50MB，ibdata2将以8MB为单位自动增长。</p><p>如果磁盘满了，你需要在另外的磁盘上面增加一个数据文件。为此，你需要查看最后一个文件的尺寸，然后计算最接近的整数（MB）。然后手工修改该文件的大小，并添加新的数据文件。例如：假设ibdata2已经有109MB数据，那么可以修改如下：<br /><span style="color: rgb(0, 255, 0);">innodb_data_file_path=/disk1/ibdata1:900M;/disk2/ibdata2:109M;/disk3/ibdata3:500M:autoextend</span></p><p><strong>flush_time</strong><br />如果系统有问题并且经常锁死或重新引导，应将该变量设置为非零值，这将导致服务器按flush_time 秒来刷新表的高速缓存。用这种方法来写出对表的修改将降低性能，但可减少表讹误或数据丢失的机会。<br />一般使用缺省值。</p><p><strong>Binlog_cache_size</strong><br />The size of the cache to hold the SQL statements for the binary log during a transaction. A binary log cache is allocated for each client if the server supports any transactional storage engines and if the server has binary log enabled(–log-bin option). If you often use big, multiple-statement transactions, you can increase this to get more performance. The Binlog_cache_use and Binlog_cache_disk_use status variables can be useful for tuning the size of this variable.</p><p><strong>3．存储引擎</strong></p><p>在MYSQL 3.23.0版本中，引入了MyISAM存储引擎。它是一个非事务型的存储引擎，成为了MYSQL的缺省存储引擎。但是，如果使用设置向导来设置参数，则它会把InnoDB作为缺省的存储引擎。InnoDB是一个事务型的存储引擎。</p><p>创建表的时候，可以为表指定存储引擎，语法如下：<br /><span style="color: rgb(51, 153, 102);">CREATE TABLE t (i INT) ENGINE = MyISAM<br />CREATE TABLE t (i INT) TYPE = MyISAM</span></p><p>如果没有指定，则使用缺省的存储引擎。也可以使用ALTER TABLE来更换表引擎，语法如下：<br /><span style="color: rgb(51, 153, 102);">ALTER TABLE t ENGINE = MyISAM</span></p><p>同一数据库中可以包含不同存储引擎的表。</p><p>事务型表具有以下特点：<br />Ø        Safer. Even if MySQL crashes or you get hardware problems, you can get your data back, either by automatic recovery or from a backup plus the transaction log.<br />Ø        You can combine many statements and accept them all at the same time with the COMMIT statement (if autocommit is disabled).<br />Ø        You can execute ROLLBACK to ignore your changes (if autocommit is disabled).<br />Ø        If an update fails, all your changes will be restored. (With non-transaction-safe tables, all changes that have taken place are permanent.)<br />Ø        Transaction-safe storage engines can provide better concurrency for tables that get many updates concurrently with reads.</p><p>非事务型表具有以下优点：<br />Ø        Much faster<br />Ø        Lower disk space requirements<br />Ø        Less memory required to perform updates</p><p><strong>4．MyISAM存储引擎</strong></p><p>下面MyISAM的参数是MySQL手册推荐的参数，据说适应于大部分情况。对于如何监视参数设置是否合理，仍然没有头绪。<br /><span style="color: rgb(0, 255, 0);">max_connections=200<br />read_buffer_size=1M<br />read_rnd_buffer_size＝8M<br />sort_buffer_size=1M<br />Read_buffer_size</span></p><p>Each thread that does a sequential scan allocates a buffer of this size for each table it scans. If you do many sequential scans, you might want to increse this value.</p><p><strong>Read_rnd_buffer_size</strong><br />When reading rows in sorted order after a sort, the rows are read through this buffer to avoid disk seeks. Setting the variable to a large value can improve ORDER BY performance by a lot. However, this is a buffer allocated for each client, so you should not set the global variable to a large value. Instead, change the session variable only from within those clients that need to run large queries.</p><p><strong>Bulk_insert_buffer_size</strong><br />该参数于4.0.3中引入。MyISAM使用一个树型的缓冲区来加速大量的插入，如<span style="color: rgb(51, 153, 102);">INSERT…SELECT，INSERT…VALUES(…),VALUES(…),…,LOAD DATA INFILE</span>等。该参数指定了缓冲区的大小。缺省值为8M，设置为0则表示不使用该优化。<br />如果不使用MyISAM表，则可以将其设置为0。</p><p><strong>5．InnoDB存储引擎</strong></p><p>参考了很多资料，都没有明确地表明如何优化InnoDB参数，以及如何监视这些参数设置是否合理，只有根据MySQL用户手册上面的介绍来进行设置。</p><p><strong>innodb_buffer_pool_size</strong><br />对于InnoDB表来说，<span style="color: rgb(0, 255, 0);">innodb_buffer_pool_size</span>的作用就相当于<span style="color: rgb(0, 255, 0);">key_buffer_size</span>对于MyISAM表的作用一样。InnoDB使用该参数指定大小的内存来缓冲数据和索引。对于单独的MySQL数据库服务器，最大可以把该值设置成物理内存的80%。</p><p>根据MySQL手册，对于2G内存的机器，推荐值是1G（50%）。</p><p><strong>innodb_flush_log_at_trx_commit</strong><br />该值指定InnoDB记录日志的方式。如果设置为1，则每个事务提交的时候，MySQL都会将事务日志写入磁盘。如果设置为0或者2，则大概每秒中将日志写入磁盘一次。（还不清楚0和2的区别）</p><p>实际测试发现，该值对插入数据的速度影响非常大，设置为2时插入10000条记录只需要2秒，设置为0时只需要1秒，而设置为1时则需要229秒。因此，MySQL手册也建议尽量将插入操作合并成一个事务，这样可以大幅提高速度。</p><p>根据MySQL手册，在存在丢失最近部分事务的危险的前提下，可以把该值设为0。</p><p><strong>innodb_log_file_size</strong><br />The size of each log file in a log group. The default is 5MB. The larger the value, the less checkpoint flush activity is needed in the buffer pool, saving disk I/O. But large log files also mean that recovery will be slower in case of a crash.</p><p>根据MySQL手册，推荐值是innodb_buffer_pool_size的25%。</p><p>注意：在重新设置该值时，好像要把原来的文件删除掉。</p><p><strong>innodb_log_buffer_size</strong><br />The size of the buffer that InnoDB uses to write to the log files on disk. Sensible values range from 1MB to 8MB. The default is 1MB. A large log buffer allows large transactions to run without a need to write the log to disk before the transactions commit. Thus, if you have big transactions, making the log buffer larger will save disk I/O.<br />根据MySQL手册，推荐值是8M。</p><p><strong>innodb_additional_mem_pool_size</strong><br />该参数指定InnoDB用来存储数据字典和其他内部数据结构的内存池大小。缺省值是1M。通常不用太大，只要够用就行，应该与表结构的复杂度有关系。如果不够用，MySQL会在错误日志中写入一条警告信息。<br />根据MySQL手册，对于2G内存的机器，推荐值是20M。</p><p><span style="color: rgb(51, 153, 102);">SHOW INNODB STATUS</span><br />显示InnoDB存储引擎的状态</p></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/165.html">JQuery 常用插件</a></li><li>Older:<a href="http://sk2.com/post/163.html">Linux网卡配置</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>