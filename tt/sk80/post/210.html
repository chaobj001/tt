<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="DNS-劫持配置:技术相关,DNS " /><meta name="description" content="DNS-劫持配置,Memcache 协议（中英对照）,10分钟搭建功能强大的 SVN版本控制系统" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>DNS-劫持配置</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/technical/">技术相关</a>&gt;<strong class="current">DNS-劫持配置</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="Memcache 协议（中英对照）" href="http://sk2.com/post/211.html" rel="nofollow">Newer</a></li><li class="older"><a title="10分钟搭建功能强大的 SVN版本控制系统" href="http://sk2.com/post/209.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>DNS-劫持配置</h1><ul class="info"><li class="date">2010年 04月10日  18:04</li><li class="category"><a href="http://sk2.com/category/technical/">技术相关</a></li></ul><div class="textbody"><p>很多电信DNS都实现了DNS-劫持,当用户输入的域名不存在时,自动转到设定好的IP</p><p>切勿用于非法用途,由于需要硬件F5支持,以下内容未经本人测试</p><p>文章来源 http://bbs2.chinaunix.net/thread-1520811-1-1.html</p><p>前提：<br />1、有F5 LTM<br />2、DNS负载并不是很高或者F5性能很好比如V10平台</p><p>原理：<br />DNS用于响应的报文由12字节长的首部和4个长度可变的字段组成。其中从第28位开始的4位的标志字段的子字段为rcode为返回码字段，通常的值为0（没有差错）和3（名字差错），名字差错从一个授权的名字服务器上返回，表示在查询中指定的域名不存在。<br />因此把rcode字段返回的值变更为指定的字符串，就可以完成nxdomain redirect的要求</p><p>iRules 是基于事件的策略，以流行的 TCL 脚本语言为基础，可帮助用户充分利用 F5 解决方案的强大能力和灵活性，进而从应用交付网络中获取最大利益（实际上就是拆包重组的过程中加入控制）</p><p>分析和脚本：（参看后文和附件），另外该脚本的作者明确说了，这种做法是违反rfc的，而且会影响antispam的blacklist技术的使用，也许还会影响对域名的判断情况，应该慎重使用。</p><p>脚本测试没有问题，在f5部署上，需要在vs中首先应用udp类型的profile，然后将该irules加入指定的vs就ok了</p><p>脚本内容:</p><p>DNS_no_more_non_existent_domain<br />.<br />Contributed by: Yang MingFei (James Yang)<br />Modified by: Nat<br />Description<br />With this rules, BIGIP can convert a “non-exist domain” DNS query result to a “normal” response to client. That will help if client type the wrong domain name (ie. if a client types “wwww.f5.com” for www.f5.com, when the request send to a load balanced DNS cache server, it will return an error message of non-exist domain (NXDOMAIN), then the plugin of browser will redirect it to an search engine or other site. After apply this rules to the BIGIP that load balances the DNS cache servers, BIGIP will replace the Cache DNS’s error message and turn it to a specified IP address like “wwww.f5.com=200.100.4.10″ in the sample rule. That the 200.100.4.10 may be portal of the service provider. Or a friendly error page that indicate the type error.</p><p>NoteRewriting non-existent domain DNS responses can introduce serious security issues for any domain which is resolved in such a manner. It may also break SPAM blacklisting. For more information, see http://www.wired.com/threatlevel/2008/04/isps-error-page/<br />iRule Source<br />when RULE_INIT {<br />set ::my_address {200 100 4 10}<br />#Addr: 200.100.4.10, you can modify your own IP address here</p><p>set ::header_without_id [binary format S5 {0x8180 0x0001 0x0001 0x0000 0x0000}]<br />#predefined fixed header<br />#      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                      ID                       |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                    QDCOUNT                    |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                    ANCOUNT                    |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                    NSCOUNT                    |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                    ARCOUNT                    |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#<br />#opcode = QUERY, rcode = NOERROR<br />#header flags:  response, auth. answer, want recursion, recursion avail.<br />#questions = 1,  answers = 1,  authority records = 0,  additional = 0</p><p>set ::answerpart [binary format S6c4 {0xC00C 0x0001 0x0001 0x0000 0x0D1B 0x0004} $::my_address]<br />#predefined Fixed Answer section<br />#Name: same as qestion<br />#Type: Host address<br />#Class: INET<br />#Time to live: 55 minutes, 55seconds<br />#Data length: 4<br />#IPv4 Addr: xxx.xxx.xxx.xxx<br />#Data Structure<br />#      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                     Name                      |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                  Answer Type                  |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |                    Class                      |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |              Time to live part 1              |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |              Time to live part 2              |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |               IP Address part 1               |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />#    |               IP Address part 2               |<br />#    +–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+–+<br />}<br />when SERVER_DATA {<br />#check rcode<br />binary scan [UDP::payload] @2S sflags<br />set rcode  [expr $sflags &amp; 0x000f]<br />#rcode = 3 Name Error (domain name referenced in the query does not exist.<br />if {$rcode == 3  }{<br /># skip the DNS header, jump to the QNAME part of first QUESTION<br /># byte contains the first part length<br />binary scan [UDP::payload] @12c foo<br /># make the byte an unsigned integer<br />set byte [expr ($foo+0x100)%0x100]<br /># initialize our posisition in the QNAME parsing and the text QNAME<br />set offset 12<br /># $i is a sanity check so this logic won’t spin on invalid QNAMEs<br />set i 0<br />############# /extract QNAME from QUESTION header #############<br />while {$byte &gt; 0 &amp;&amp; $i &lt; 10} {<br /># grab a part and put it in our text QNAME section<br />set offset [expr $offset + $byte + 1]<br /># grab the length of the next part, and make it an unsigned integer<br />binary scan [UDP::payload] @${offset}c foo<br />set byte [expr ($foo+0x100)%0x100 ]<br />incr i<br />}<br /># increment offset past the final part so it points at the QTYPE field<br />incr offset<br />############# extract QTYPE from QUESTION header #############<br /># grab the next 2 bytes that represent the QTYPE<br />binary scan [UDP::payload] @${offset}S qtype<br /># see if the QTYPE is 0×0001 (TYPE_AAAA), if it’s a A query, then replace the content<br />if {$qtype == 0×0001} {<br />#Pack the respond packet<br />#keep original query id<br />#replace header with predefined header without id (answer part and remove NS/AR part<br />#replace the rest of packet after query section with predefined answer section<br />UDP::payload replace 2 10 $::header_without_id<br />incr offset 4<br />UDP::payload replace $offset [expr [UDP::payload length] – $offset ] $::answerpart<br />}<br />}<br />}</p><p>下载:<a href="http://www.gaojinbo.com/wp-content/uploads/2009/08/F5-DNS-%E5%8A%AB%E6%8C%81%E9%85%8D%E7%BD%AE.pdf">F5-DNS-劫持配置</a></p></div><div class="entry-tags"><strong>Tags:</strong><a href="http://sk2.com/tag/DNS/">DNS</a></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/211.html">Memcache 协议（中英对照）</a></li><li>Older:<a href="http://sk2.com/post/209.html">10分钟搭建功能强大的 SVN版本控制系统</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>