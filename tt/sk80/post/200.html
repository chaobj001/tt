<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="使用Nginx的proxy_cache缓存功能取代Squid:Nginx," /><meta name="description" content="使用Nginx的proxy_cache缓存功能取代Squid,nginx限制ip并发数,PHP安全配置" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>使用Nginx的proxy_cache缓存功能取代Squid</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/nginx/">Nginx</a>&gt;<strong class="current">使用Nginx的proxy_cache缓存功能取代Squid</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="nginx限制ip并发数" href="http://sk2.com/post/201.html" rel="nofollow">Newer</a></li><li class="older"><a title="PHP安全配置" href="http://sk2.com/post/199.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>使用Nginx的proxy_cache缓存功能取代Squid</h1><ul class="info"><li class="date">2010年 04月10日  17:46</li><li class="category"><a href="http://sk2.com/category/nginx/">Nginx</a></li></ul><div class="textbody">Nginx从0.7.48版本开始，支持了类似Squid的缓存功能。这个缓存是把URL及相关组合当作Key，用md5编码哈希后保存在硬盘上，所以它可以支持任意URL链接，同时也支持404/301/302这样的非200状态码。虽然目前官方的Nginx Web缓存服务只能为指定URL或状态码设置过期时间，不支持类似Squid的PURGE指令，手动清除指定缓存页面，但是，通过一个第三方的Nginx 模块，可以清除指定URL的缓存。    <br /> Nginx的Web缓存服务主要由proxy_cache相关指令集和fastcgi_cache相关指令集构成，前者用于反向代理时，对后端内容源服务器进行缓存，后者主要用于对FastCGI的动态程序进行缓存。两者的功能基本上一样。    <br /> 最新的Nginx 0.8.32版本，proxy_cache和fastcgi_cache已经比较完善，加上第三方的ngx_cache_purge模块（用于清除指定 URL的缓存），已经可以完全取代Squid。我们已经在生产环境使用了 Nginx 的 proxy_cache 缓存功能超过两个月，十分稳定，速度不逊于 Squid。    <br /> 在功能上，Nginx已经具备Squid所拥有的Web缓存加速功能、清除指定URL缓存的功能。而在性能上，Nginx对多核CPU的利用，胜过Squid不少。另外，在反向代理、负载均衡、健康检查、后端服务器故障转移、 Rewrite重写、易用性上，Nginx也比Squid强大得多。这使得一台Nginx可以同时作为“负载均衡服务器”与“Web缓存服务器”来使用。<hr /> 1、Nginx 负载均衡与缓存服务器在 Linux 下的编译安装：<p>ulimit -SHn 65535   <br />wget <a href="ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.00.tar.gz">ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-8.00.tar.gz</a>    <br />tar zxvf pcre-8.00.tar.gz    <br />cd pcre-8.00/    <br />./configure    <br />make &amp;&amp; make install    <br />cd ../    <br />wget <a href="http://labs.frickle.com/files/ngx_cache_purge-1.0.tar.gz">http://labs.frickle.com/files/ngx_cache_purge-1.0.tar.gz</a>    <br />tar zxvf ngx_cache_purge-1.0.tar.gz    <br />wget <a href="http://nginx.org/download/nginx-0.8.32.tar.gz">http://nginx.org/download/nginx-0.8.32.tar.gz</a>    <br />tar zxvf nginx-0.8.32.tar.gz    <br />cd nginx-0.8.32/    <br />./configure –user=www –group=www –add-module=../ngx_cache_purge-1.0 –prefix=/usr/local/webserver/nginx –with-http_stub_status_module –with-http_ssl_module    <br />make &amp;&amp; make install    <br />cd ../</p><hr /> 2、/usr/local/webserver/nginx/conf/nginx.conf 配置文件内容如下：<p>user&nbsp; www www;   <br />worker_processes 8;    <br />error_log&nbsp; /usr/local/webserver/nginx/logs/nginx_error.log&nbsp; crit;    <br />pid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/local/webserver/nginx/nginx.pid;    <br />#Specifies the value for maximum file descriptors that can be opened by this process.     <br />worker_rlimit_nofile 65535;    <br />events     <br />{    <br />&nbsp; use epoll;    <br />&nbsp; worker_connections 65535;    <br />}    <br />http     <br />{    <br />&nbsp; include&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mime.types;    <br />&nbsp; default_type&nbsp; application/octet-stream;    <br />&nbsp; charset&nbsp; utf-8;    <br />&nbsp; server_names_hash_bucket_size 128;    <br />&nbsp; client_header_buffer_size 32k;    <br />&nbsp; large_client_header_buffers 4 32k;    <br />&nbsp; client_max_body_size 300m;    <br />&nbsp; sendfile on;    <br />&nbsp; tcp_nopush&nbsp;&nbsp;&nbsp;&nbsp; on;    <br />&nbsp; keepalive_timeout 60;    <br />&nbsp; tcp_nodelay on;    <br />&nbsp; client_body_buffer_size&nbsp; 512k;    <br />&nbsp; proxy_connect_timeout&nbsp;&nbsp;&nbsp; 5;    <br />&nbsp; proxy_read_timeout&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 60;    <br />&nbsp; proxy_send_timeout&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5;    <br />&nbsp; proxy_buffer_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 16k;    <br />&nbsp; proxy_buffers&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 64k;    <br />&nbsp; proxy_busy_buffers_size 128k;    <br />&nbsp; proxy_temp_file_write_size 128k;    <br />&nbsp; gzip on;    <br />&nbsp; gzip_min_length&nbsp; 1k;    <br />&nbsp; gzip_buffers&nbsp;&nbsp;&nbsp;&nbsp; 4 16k;    <br />&nbsp; gzip_http_version 1.1;    <br />&nbsp; gzip_comp_level 2;    <br />&nbsp; gzip_types&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; text/plain application/x-javascript text/css application/xml;    <br />&nbsp; gzip_vary on;    <br />&nbsp; #注：proxy_temp_path和proxy_cache_path指定的路径必须在同一分区    <br />&nbsp; proxy_temp_path&nbsp;&nbsp; /data0/proxy_temp_dir;    <br />&nbsp; #设置Web缓存区名称为cache_one，内存缓存空间大小为200MB，1天清理一次缓存，硬盘缓存空间大小为30GB。    <br />&nbsp; proxy_cache_path&nbsp; /data0/proxy_cache_dir&nbsp; levels=1:2&nbsp;&nbsp; keys_zone=cache_one:200m inactive=1d max_size=30g;    <br />&nbsp; upstream backend_server {    <br />&nbsp;&nbsp;&nbsp; server&nbsp;&nbsp; 192.168.8.43:80 weight=1 max_fails=2 fail_timeout=30s;    <br />&nbsp;&nbsp;&nbsp; server&nbsp;&nbsp; 192.168.8.44:80 weight=1 max_fails=2 fail_timeout=30s;    <br />&nbsp;&nbsp;&nbsp; server&nbsp;&nbsp; 192.168.8.45:80 weight=1 max_fails=2 fail_timeout=30s;    <br />&nbsp; }    <br />&nbsp; server    <br />&nbsp; {    <br />&nbsp;&nbsp;&nbsp; listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 80;    <br />&nbsp;&nbsp;&nbsp; server_name&nbsp; www.yourdomain.com 192.168.8.42;    <br />&nbsp;&nbsp;&nbsp; index index.html index.htm;    <br />&nbsp;&nbsp;&nbsp; root&nbsp; /data0/htdocs/www;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; location /    <br />&nbsp;&nbsp;&nbsp; {    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #如果后端的服务器返回502、504、执行超时等错误，自动将请求转发到upstream负载均衡池中的另一台服务器，实现故障转移。    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_next_upstream http_502 http_504 error timeout invalid_header;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_cache cache_one;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #对不同的HTTP状态码设置不同的缓存时间    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_cache_valid&nbsp; 200 304 12h;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #以域名、URI、参数组合成Web缓存的Key值，Nginx根据Key值哈希，存储缓存内容到二级缓存目录内    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_cache_key $host$uri$is_args$args;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_set_header Host&nbsp; $host;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_set_header X-Forwarded-For&nbsp; $remote_addr;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_pass http://backend_server;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; expires&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1d;    <br />&nbsp;&nbsp;&nbsp; }    <br />&nbsp;&nbsp;&nbsp; #用于清除缓存，假设一个URL为http://192.168.8.42/test.txt，通过访问http://192.168.8.42/purge/test.txt就可以清除该URL的缓存。    <br />&nbsp;&nbsp;&nbsp; location ~ /purge(/.*)    <br />&nbsp;&nbsp;&nbsp; {    <br />&nbsp;&nbsp;&nbsp;&nbsp; #设置只允许指定的IP或IP段才可以清除URL缓存。    <br />&nbsp;&nbsp;&nbsp;&nbsp; allow&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1;    <br />&nbsp;&nbsp;&nbsp;&nbsp; allow&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.0.0/16;    <br />&nbsp;&nbsp;&nbsp;&nbsp; deny&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all;    <br />&nbsp;&nbsp;&nbsp;&nbsp; proxy_cache_purge&nbsp;&nbsp;&nbsp; cache_one&nbsp;&nbsp; $host$1$is_args$args;    <br />&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; #扩展名以.php、.jsp、.cgi结尾的动态应用程序不缓存。    <br />&nbsp;&nbsp;&nbsp; location ~ .*\.(php|jsp|cgi)?$    <br />&nbsp;&nbsp;&nbsp; {    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_set_header Host&nbsp; $host;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_set_header X-Forwarded-For&nbsp; $remote_addr;    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; proxy_pass http://backend_server;    <br />&nbsp;&nbsp;&nbsp; }    <br />&nbsp;&nbsp;&nbsp; access_log&nbsp; off;    <br />&nbsp; }    <br />}</p><hr /> 3、启动 Nginx：<p>/usr/local/webserver/nginx/sbin/nginx</p><hr /> 4、清除指定的URL缓存示例：  <br /><a href="http://blog.s135.com/attachment/201001/nginx_purge.png"><img title="点击在新窗口中浏览此图片" alt="点击在新窗口中浏览此图片" src="http://blog.s135.com/attachment/201001/nginx_purge.png" border="0" /></a></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/201.html">nginx限制ip并发数</a></li><li>Older:<a href="http://sk2.com/post/199.html">PHP安全配置</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>