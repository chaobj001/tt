<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="PHP 大文件上传进度条实现:PHP,apc " /><meta name="description" content="PHP 大文件上传进度条实现,配置Apache为你的网站加速,Memcached 集群架构方面的问题" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>PHP 大文件上传进度条实现</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/php/">PHP</a>&gt;<strong class="current">PHP 大文件上传进度条实现</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="配置Apache为你的网站加速" href="http://sk2.com/post/216.html" rel="nofollow">Newer</a></li><li class="older"><a title="Memcached 集群架构方面的问题" href="http://sk2.com/post/214.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>PHP 大文件上传进度条实现</h1><ul class="info"><li class="date">2010年 04月10日  18:14</li><li class="category"><a href="http://sk2.com/category/php/">PHP</a></li></ul><div class="textbody"><p>目前我知道的方法有两种，一种是使用PHP的创始人 Rasmus Lerdorf 写的APC扩展模块来实现（http://pecl.php.net/package/apc），另外一种方法是使用PECL扩展模块uploadprogress实现（http://pecl.php.net/package/uploadprogress） 我这里举两个分别实现的例子供参考，更灵活的应用根据自己需要来修改。</p><p></p><p>　　APC实现方法：</p><ul><li>安装APC，参照官方文档安装，可以使用PECL模块安装方法快速简捷，这里不说明</li><li>配置php.ini，设置参数 apc.rfc1867=1 ，使APC支持上传进度条功能，在APC源码说明文档里面有说明</li><li>代码范例：<div class="hl-surround"><div class="hl-main"><span style="color: green;">if</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_SERVER</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">REQUEST_METHOD</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;"> == </span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">POST</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: olive;">)</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;">&nbsp; </span><span style="color: rgb(255, 165, 0);">//上传请求</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$status</span><span style="color: gray;"> = </span><span style="color: blue;">apc_fetch</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">upload_</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: gray;"> . </span><span style="color: rgb(0, 0, 139);">$_POST</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">APC_UPLOAD_PROGRESS</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">])</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$status</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">done</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;"> = </span><span style="color: maroon;">1</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">echo</span><span style="color: gray;"> </span><span style="color: blue;">json_encode</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$status</span><span style="color: olive;">)</span><span style="color: gray;">;&nbsp; </span><span style="color: rgb(255, 165, 0);">//输出给用户端页面里的ajax调用，相关文档请自己寻找</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">exit</span><span style="color: gray;">;<br /></span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">elseif</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: green;">isset</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_GET</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">progress_key</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]))</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;">&nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//读取上传进度</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$status</span><span style="color: gray;"> = </span><span style="color: blue;">apc_fetch</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">upload_</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: gray;">.</span><span style="color: rgb(0, 0, 139);">$_GET</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">progress_key</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">])</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">echo</span><span style="color: gray;"> </span><span style="color: blue;">json_encode</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$status</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">exit</span><span style="color: gray;">;<br /></span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">else</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//其他代码，比如上传表单等</span><span style="color: gray;"><br /></span><span style="color: olive;">}</span></div></div></li></ul><p>　　uploadprogress 模块实现方法：</p><ul><li>使用PECL模块安装方法安装该模块</li><li>php.ini里面设置 uploadprogress.file.filename_template = “/tmp/upd_%s.txt”</li><li>代码范例：<div class="hl-surround"><div class="hl-main"><span style="color: green;">if</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_SERVER</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">REQUEST_METHOD</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;">==</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">POST</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: olive;">)</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">if</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: blue;">is_uploaded_file</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_FILES</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">upfile</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">][</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">tmp_name</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]))</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$upload_dir</span><span style="color: gray;"> = </span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">your_path/</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$ext</span><span style="color: gray;">&nbsp; &nbsp; &nbsp; &nbsp; = </span><span style="color: blue;">strrchr</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_FILES</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">video</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">][</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">name</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;">, </span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: red;">.</span><span style="color: rgb(139, 0, 0);">‘</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$sessid</span><span style="color: gray;">&nbsp; &nbsp; &nbsp;= </span><span style="color: rgb(0, 0, 139);">$_POST</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">UPLOAD_IDENTIFIER</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;"> ;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$tmpfile</span><span style="color: gray;">&nbsp; &nbsp; = </span><span style="color: rgb(0, 0, 139);">$upload_dir</span><span style="color: gray;"> . </span><span style="color: rgb(0, 0, 139);">$sessid</span><span style="color: gray;">;&nbsp;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$sessfile</span><span style="color: gray;">&nbsp; &nbsp;= </span><span style="color: rgb(0, 0, 139);">$upload_dir</span><span style="color: gray;"> . </span><span style="color: rgb(0, 0, 139);">$sessid</span><span style="color: gray;"> .</span><span style="color: rgb(0, 0, 139);">$ext</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: green;">if</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: blue;">move_uploaded_file</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_FILES</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">upfile</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">][</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">tmp_name</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;">,</span><span style="color: rgb(0, 0, 139);">$tmpfile</span><span style="color: olive;">))</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//上传成功</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">else</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//上传失败</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">else</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//上传错误</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<br /></span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">elseif</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: gray;">!</span><span style="color: green;">empty</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$_GET</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">sessid</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]))</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Expires: Mon, 26 Jul 1997 05:00:00 GMT</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Last-Modified: </span><span style="color: rgb(139, 0, 0);">“</span><span style="color: gray;"> . </span><span style="color: blue;">gmdate</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">D, d M Y H:i:s</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;"> . </span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;"> GMT</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Cache-Control: no-store, no-cache, must-revalidate</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Cache-Control: post-check=0, pre-check=0</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: gray;">, </span><span style="color: green;">false</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Pragma: no-cache</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: blue;">header</span><span style="color: olive;">(</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: red;">Content-Type:text/html;charset=UTF-8</span><span style="color: rgb(139, 0, 0);">“</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$unique_id</span><span style="color: gray;"> = </span><span style="color: rgb(0, 0, 139);">$_GET</span><span style="color: olive;">[</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: red;">sessid</span><span style="color: rgb(139, 0, 0);">'</span><span style="color: olive;">]</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(0, 0, 139);">$uploadvalues</span><span style="color: gray;"> = </span><span style="color: blue;">uploadprogress_get_info</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$unique_id</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: green;">if</span><span style="color: gray;"> </span><span style="color: olive;">(</span><span style="color: blue;">is_array</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$uploadvalues</span><span style="color: olive;">))</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: green;">echo</span><span style="color: gray;"> </span><span style="color: blue;">json_encode</span><span style="color: olive;">(</span><span style="color: rgb(0, 0, 139);">$uploadvalues</span><span style="color: olive;">)</span><span style="color: gray;">;<br />&nbsp;&nbsp; &nbsp;</span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">else</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//读取进度失败，另外处理逻辑</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: olive;">}</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;<br /></span><span style="color: olive;">}</span><span style="color: gray;"> </span><span style="color: green;">else</span><span style="color: gray;"> </span><span style="color: olive;">{</span><span style="color: gray;"><br />&nbsp;&nbsp; &nbsp;</span><span style="color: rgb(255, 165, 0);">//显示上传表单</span><span style="color: gray;"><br /></span><span style="color: olive;">}</span></div></div></li></ul></div><div class="entry-tags"><strong>Tags:</strong><a href="http://sk2.com/tag/apc/">apc</a></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/216.html">配置Apache为你的网站加速</a></li><li>Older:<a href="http://sk2.com/post/214.html">Memcached 集群架构方面的问题</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>