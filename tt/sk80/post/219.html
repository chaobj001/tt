<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="PHP二分查找法应用之IP查找:PHP," /><meta name="description" content="PHP二分查找法应用之IP查找,event.keycode 对应的数字,带你深入了解Web站点数据库的分布存储" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>PHP二分查找法应用之IP查找</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/php/">PHP</a>&gt;<strong class="current">PHP二分查找法应用之IP查找</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="event.keycode 对应的数字" href="http://sk2.com/post/220.html" rel="nofollow">Newer</a></li><li class="older"><a title="带你深入了解Web站点数据库的分布存储" href="http://sk2.com/post/218.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>PHP二分查找法应用之IP查找</h1><ul class="info"><li class="date">2010年 04月10日  18:18</li><li class="category"><a href="http://sk2.com/category/php/">PHP</a></li></ul><div class="textbody"><p>PHP二分查找法应用之IP查找<br />前段时间做数据分析，需要大量的IP地址查询（每秒钟近万次检索），首先考虑到使用数据库。数据库大概存储几十万条IP记录，记录集如下：</p><p>+———-+———-+————+———+———+——–+——–+<br />|&nbsp;&nbsp;ip_begin&nbsp;&nbsp; |&nbsp;&nbsp; ip_end&nbsp;&nbsp; | country_id | prov_id | city_id | isp_id | netbar |<br />+———-+———-+————+———+———+——–+——–+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0| 16777215 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |<br />| 16777216 | 33554431 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |<br />| 33554432 | 50331647 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |<br />| 50331648 | 67108863 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |<br />| 67108864 | 67829759 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 |<br />+———-+———-+————+———+———+——–+——–+ 　<br />　这样做查询需要用到如下SQL：<br /><a name="entrymore"></a></p><div>&lt;?php$sql = ‘SELECT * FROM i_m_ip WHERE ip_begin &lt;= $client_ip AND ip_end &gt;= $client_ip’;?&gt;</div><p>　　这样的检索显然用不到索引，即使用到，MySQL查询效率也不大可能达到每秒500次以上，我做了很多并发优化，最终平均查询效率也只有每秒200次左右，实在是头痛。一开始我也有想到借鉴纯真IP库的检索方法，但是我一直对算法有抵触，也以为二分法很难，所以就没有尝试使用，直到最后没有办法了，才最终实现了二分法的IP地址检索。<span id="more-470"></span><br />　　从上表可以看到IP库是从0到4294967295的一个连续数值，这个数值要是拆开存储，会有几百G的数据，所以没办法使用索引也没办法哈希。最终我使用PHP将这些东东转为二进制存储，抛弃了数据库的检索。可以看到IP起止长度为一个4字节的长整型，后面的国家ID、省份ID等，可以使用2个字节的短整型来存储，总共一行数据就有18个字节，总共31万条数据，算起来也就5M的样子。具体IP库生成代码如下：</p><div>&lt;?php</div><p>/*<br />IP文件格式：<br />3741319168 3758096383 182 0 0 0 0<br />3758096384 3774873599 3 0 0 0 0<br />3774873600 4026531839 182 0 0 0 0<br />4026531840 4278190079 182 0 0 0 0<br />4294967040 4294967295 312 0 0 0 0<br />*/<br />set_time_limit(0);<br />$handle = fopen(‘./ip.txt’, ‘rb’);<br />$fp = fopen(“./ip.dat”, ‘ab’);<br />if ($handle) {<br />while (!feof($handle)) {<br />$buffer = fgets($handle);<br />$buffer = trim($buffer);<br />$buffer = explode(“\t”, $buffer);<br />foreach ($buffer as $key =&gt; $value) {<br />$buffer[$key] = (float) trim($value);<br />}<br />$str = pack(‘L’, $buffer[0]);<br />$str .= pack(‘L’, $buffer[1]);<br />$str .= pack(‘S’, $buffer[2]);<br />$str .= pack(‘S’, $buffer[3]);<br />$str .= pack(‘S’, $buffer[4]);<br />$str .= pack(‘S’, $buffer[5]);<br />$str .= pack(‘S’, $buffer[6]);<br />fwrite($fp, $str);<br />}<br />}</p><p>?&gt;</p><p>这样IP就按照顺序每18字节一个单位排列了，所以很容易就使用二分法来检索出IP信息：</p><div>&lt;?php<br />function getip($ip, $fp) {<br />fseek($fp, 0);<br />$begin = 0;<br />$end = filesize(‘./ip.dat’);<br />$begin_ip = implode(”, unpack(‘L’, fread($fp, 4)));<br />fseek($fp, $end – 14);<br />$end_ip = implode(”, unpack(‘L’, fread($fp, 4)));<br />$begin_ip = sprintf(‘%u’, $begin_ip);<br />$end_ip = sprintf(‘%u’, $end_ip);</div><p>do {<br />if ($end – $begin &lt;= 18) {<br />fseek($fp, $begin + 8);<br />$info = array();<br />$info[0] = implode(”, unpack(‘S’, fread($fp, 2)));<br />$info[1] = implode(”, unpack(‘S’, fread($fp, 2)));<br />$info[2] = implode(”, unpack(‘S’, fread($fp, 2)));<br />$info[3] = implode(”, unpack(‘S’, fread($fp, 2)));<br />$info[4] = implode(”, unpack(‘S’, fread($fp, 2)));<br />return $info;<br />}</p><p>$middle_seek = ceil((($end – $begin) / 18) / 2) * 18 + $begin;</p><p>fseek($fp, $middle_seek);<br />$middle_ip = implode(”, unpack(‘L’, fread($fp, 4)));<br />$middle_ip = sprintf(‘%u’, $middle_ip);</p><p>if ($ip &gt;= $middle_ip) {<br />$begin = $middle_seek;<br />} else {<br />$end = $middle_seek;<br />}<br />} while (true);<br />}</p><p>?&gt;</p><p>　　以上$fp为打开ip.dat的文件句柄，由于是循环检索，所以写在函数外面，免得每次检索都要打开一次文件，30W行数据二分法最多也只需要循环7次(2^7)左右即可找到准确的IP信息。之后本来还想将ip.dat放在内存中加快检索速度，后来发现，字符串定位函数的效率，根本和文件指针的偏移定位不是在一个数量级的，所以还是放弃使用内存来存放IP库。<br />　　这个实现，使IP检索效率提高了近百倍，只是一个简单的二分法的应用，从此算法在WEB应用中不重要的观念彻底打消了</p></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/220.html">event.keycode 对应的数字</a></li><li>Older:<a href="http://sk2.com/post/218.html">带你深入了解Web站点数据库的分布存储</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>