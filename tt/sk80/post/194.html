<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="使用Apache做负载均衡:Apache," /><meta name="description" content="使用Apache做负载均衡,linux下shell命令的常用快捷键,MySQL 优化编译" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>使用Apache做负载均衡</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/apache/">Apache</a>&gt;<strong class="current">使用Apache做负载均衡</strong></p><ul id="flip1" class="flip"><li class="newer"><a title="linux下shell命令的常用快捷键" href="http://sk2.com/post/195.html" rel="nofollow">Newer</a></li><li class="older"><a title="MySQL 优化编译" href="http://sk2.com/post/193.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>使用Apache做负载均衡</h1><ul class="info"><li class="date">2010年 04月10日  16:54</li><li class="category"><a href="http://sk2.com/category/apache/">Apache</a></li></ul><div class="textbody"><p>第一次看到这个标题时我也很惊讶，Apache居然还能做负载均衡？真是太强大了。经过一番调查后发现的确可以，而且功能一点都不差。这都归功于 mod_proxy 这个模块。不愧是强大的Apache啊。</p><p>废话少说，下面就来解释一下负载均衡的设置方法。</p><!-- end Pukiwiki generated code--><span id="more-709"></span><!-- begin Pukiwiki generated code--><p>一般来说，负载均衡就是将客户端的请求分流给后端的各个真实服务器，达到负载均衡的目的。还有一种方式是用两台服务器，一台作为主服务器(Master)，另一台作为热备份(Hot Standby)，请求全部分给主服务器，在主服务器当机时，立即切换到备份服务器，以提高系统的整体可靠性。</p><p><strong>负载均衡的设置</strong></p><p>Apache可以应对上面这两种需求。先来讨论一下如何做负载均衡。首先需要启用Apache的几个模块：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule proxy_http_module modules/mod_proxy_http.so</pre></div><br /></p><p>mod_proxy提供代理服务器功能，mod_proxy_balancer提供负载均衡功能，mod_proxy_http让代理服务器能支持HTTP协议。如果把mod_proxy_http换成其他协议模块（如mod_proxy_ftp），或许能支持其他协议的负载均衡，有兴趣的朋友可以自己尝试一下。</p><p>然后要添加以下配置：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">ProxyRequests Off
&lt;Proxy balancer://mycluster&gt;
    BalancerMember http://node-a.myserver.com:<span style="">8080</span>
    BalancerMember http://node-b.myserver.com:<span style="">8080</span>
&lt;/Proxy&gt;
ProxyPass / balancer://mycluster
&nbsp;
# 警告：以下这段配置仅用于调试，绝不要添加到生产环境中！！！
&lt;Location /balancer-manager&gt;
    SetHandler balancer-manager
    Order Deny,Allow
    Deny from all
    Allow from localhost
&lt;/Location&gt;</pre></div><br />从上面的 ProxyRequests Off 这条可以看出，实际上负载均衡器就是一个反向代理，只不过它的代理转发地址不是某台具体的服务器，而是一个 balancer:// 协议：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">ProxyPass / balancer://mycluster</pre></div><br /></p><p>协议地址可以随便定义。然后，在&lt;Proxy&gt;段中设置该balancer协议的内容即可。BalancerMember指令可以添加负载均衡组中的真实服务器地址。</p><p>下面那段&lt;Location /balancer-manager&gt;是用来监视负载均衡的工作情况的，调试时可以加上（生产环境中禁止使用！），然后访问 <a href="http://localhost/balancer-manager/">http://localhost/balancer-manager/</a> 即可看到负载均衡的工作状况。</p><p>OK，改完之后重启服务器，访问你的Apache所在服务器的地址，即可看到负载均衡的效果了。打开 balancer-manager 的界面，可以看到请求是平均分配的。</p><p>如果不想平均分配怎么办？给 BalancerMember 加上 loadfactor 参数即可，取值范围为1-100。比如你有三台服务器，负载分配比例为 7:2:1，只需这样设置：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">ProxyRequests Off
&lt;Proxy balancer://mycluster&gt;
    BalancerMember http://node-a.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">7</span>
    BalancerMember http://node-b.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">2</span>
    BalancerMember http://node-c.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">1</span>
&lt;/Proxy&gt;
ProxyPass / balancer://mycluster</pre></div><br />默认情况下，负载均衡会尽量让各个服务器接受的请求次数满足预设的比例。如果要改变算法，可以使用 lbmethod 属性。如：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">ProxyRequests Off
&lt;Proxy balancer://mycluster&gt;
    BalancerMember http://node-a.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">7</span>
    BalancerMember http://node-b.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">2</span>
    BalancerMember http://node-c.myserver.com:<span style="">8080</span> loadfactor<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">1</span>
&lt;/Proxy&gt;
ProxyPass / balancer://mycluster
ProxySet lbmethod<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">bytraffic</span></pre></div><br /></p><p>lbmethod可能的取值有：</p><div class="ie5"><table class="style_table" border="0" cellspacing="1"><tbody><tr><td class="style_td">lbmethod=byrequests</td><td class="style_td">按照请求次数均衡(默认)</td></tr><tr><td class="style_td">lbmethod=bytraffic</td><td class="style_td">按照流量均衡</td></tr><tr><td class="style_td">lbmethod=bybusyness</td><td class="style_td">按照繁忙程度均衡(总是分配给活跃请求数最少的服务器)</td></tr></tbody></table></div><p>各种算法的原理请参见<a href="http://httpd.apache.org/docs/2.2/en/mod/mod_proxy_balancer.html">Apache的文档</a>。</p><p><strong>热备份(Hot Standby)</strong></p><p>热备份的实现很简单，只需添加 status=+H 属性，就可以把某台服务器指定为备份服务器：<br /><div class="code"><pre class="ini" style="font-family:Andale Mono,Lucida Console,Monaco,fixed,monospace;">ProxyRequests Off
&lt;Proxy balancer://mycluster&gt;
    BalancerMember http://node-a.myserver.com:<span style="">8080</span>
    BalancerMember http://node-b.myserver.com:<span style="">8080</span> status<span style="color: #000066; font-weight:bold;">=</span><span style="color: #660066;">+H</span>
&lt;/Proxy&gt;
ProxyPass / balancer://mycluster</pre></div><br />从 balancer-manager 界面中可以看到，请求总是流向 node-a ，一旦node-a挂掉，Apache会检测到错误并把请求分流给 node-b。Apache会每隔几分钟检测一下 node-a 的状况，如果node-a恢复，就继续使用node-a。</p><p></p><p></p><p></p></div></div><ul id="flip2" class="flip"><li>Newer:<a href="http://sk2.com/post/195.html">linux下shell命令的常用快捷键</a></li><li>Older:<a href="http://sk2.com/post/193.html">MySQL 优化编译</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>