<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="generator" content="blog.sk80.com" /><meta name="keywords" content="PHP企业级应用之常见缓存技术篇:PHP," /><meta name="description" content="PHP企业级应用之常见缓存技术篇,,PHP文件上传$_FILES数组error键各值含义说明" /><meta name="author" content="4kychao" /><link rel="stylesheet" type="text/css" href="http://sk2.com/templates/default/style.css" /><title>PHP企业级应用之常见缓存技术篇</title></head><body><div id="wrapper"><div id="header"><div id="header-inner"><p class="sitename">blog.sk80.com</p><div class="description">等我有钱了, 咱买棒棒糖, 买2 根, 1 根 你看着我吃, 另1根 我吃给你看。</div><div class="menu"><ul><li class="current_page"><a rel="nofollow" href="/">日志</a></li><!--li><a href="#">About</a></li--></ul></div></div></div><div id="wrapper-inner"><p id="topic-path"><a href="/" rel="nofollow">Home</a>&gt;<a href="http://sk2.com/category/php/">PHP</a>&gt;<strong class="current">PHP企业级应用之常见缓存技术篇</strong></p><ul id="flip1" class="flip"><li class="older"><a title="PHP文件上传$_FILES数组error键各值含义说明" href="http://sk2.com/post/225.html" rel="nofollow">Older</a></li></ul><div id="detail"><div class="post"><h1>PHP企业级应用之常见缓存技术篇</h1><ul class="info"><li class="date">2010年 04月10日  18:30</li><li class="category"><a href="http://sk2.com/category/php/">PHP</a></li></ul><div class="textbody"><p>别每天OO，这个配置怎么改，这段代码哪错了，没劲，好的程序不光是代码写的好，整体架构很重要，多了解程序之外的东西，这篇不再单单是程序方面的东西了，会写到从程序到服务器的设置，会比较多，但个人的经验有限，知道的就这么多，不知道的我也没法写呀， 文章说的不好大家就当我说梦话得了。<br />所有程序例子都来自网络<span id="more-345"></span></p><p><strong>普遍缓存技术</strong></p><p>数据缓存：这里所说的数据缓存是指数据库查询缓存，每次访问页面的时候,都会先检测相应的缓存数据是否存在，如果不存在，就连接数据库，得到数据，并把查询结果序列化后保存到文件中，以后同样的查询结果就直接从缓存表或文件中获得。</p><p>用的最广的例子看Discuz的搜索功能，把结果ID缓存到一个表中，下次搜索相同关键字时先搜索缓存表。</p><p>举个常用的方法，多表关联的时候，把附表中的内容生成数组保存到主表的一个字段中，需要的时候数组分解一下，这样的好处是只读一个表，坏处就是两个数据同步会多不少步骤，数据库永远是瓶颈，用硬盘换速度，是这个的关键点。</p><p><strong>页面缓存</strong>：</p><p>每次访问页面的时候，都会先检测相应的缓存页面文件是否存在，如果不存在，就连接数据库，得到数据，显示页面并同时生成缓存页面文件，这样下次访问的时候页面文件就发挥作用了。(模板引擎和网上常见的一些缓存类通常有此功能)</p><p><strong>时间触发缓存</strong>：</p><p>检查文件是否存在并且时间戳小于设置的过期时间,如果文件修改的时间戳比当前时间戳减去过期时间戳大，那么就用缓存，否则更新缓存。</p><p><strong>内容触发缓存</strong>：</p><p>当插入数据或更新数据时，强制更新缓存。</p><p><strong>静态缓存：</strong></p><p>这里所说的静态缓存是指静态化，直接生成HTML或XML等文本文件，有更新的时候重生成一次，适合于不太变化的页面，这就不说了。</p><p>以上内容是代码级的解决方案，我直接CP别的框架，也懒得改，内容都差不多，很容易就做到，而且会几种方式一起用，但下面的内容是服务器端的缓存方案，非代码级的，要有多方的合作才能做到</p><p><strong>内存缓存:</strong></p><p>Memcached是高性能的，分布式的内存对象缓存系统，用于在动态应用中减少数据库负载，提升访问速度。</p><p>这里说下Memcached的例子：</p><p><span class="code">&lt;?php<br />$memcache = new Memcache;<br />$memcache-&gt;connect(‘localhost’, 11211) or die (“Could not connect”);<br />$version = $memcache-&gt;getVersion();<br />echo “Server’s version: “.$version.”\n”;<br />$tmp_object = new stdClass;<br />$tmp_object-&gt;str_attr = ‘test’;<br />$tmp_object-&gt;int_attr = 123;<br />$memcache-&gt;set(‘key’, $tmp_object, false, 10) or die (“Failed to save data at the server”);<br />echo “Store data in the cache (data will expire in 10 seconds)\n”;<br />$get_result = $memcache-&gt;get(‘key’);<br />echo “Data from the cache:\n”;<br />var_dump($get_result);<br />?&gt;</span></p><p>读库的例子：</p><p><span class="code">&lt;?php<br />$sql = ‘SELECT * FROM users’;<br />$key = md5($sql);&nbsp;&nbsp; //memcached 对象标识符<br />if ( !($datas = $mc-&gt;get($key)) ) {<br />&nbsp;&nbsp;&nbsp; //&nbsp; 在 memcached 中未获取到缓存数据，则使用数据库查询获取记录集。<br />&nbsp;&nbsp;&nbsp; echo “n”.str_pad(‘Read datas from MySQL.’, 60, ‘_’).”n”;<br />&nbsp;&nbsp;&nbsp; $conn = mysql_connect(‘localhost’, ‘test’, ‘test’);<br />&nbsp;&nbsp;&nbsp; mysql_select_db(‘test’);<br />&nbsp;&nbsp;&nbsp; $result = mysql_query($sql);<br />&nbsp;&nbsp;&nbsp; while ($row = mysql_fetch_object($result))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $datas[] = $row;<br />&nbsp;&nbsp;&nbsp; //&nbsp; 将数据库中获取到的结果集数据保存到 memcached 中，以供下次访问时使用。<br />&nbsp;&nbsp;&nbsp; $mc-&gt;add($key, $datas);<br />} else {<br />&nbsp;&nbsp;&nbsp; echo “n”.str_pad(‘Read datas from memcached.’, 60, ‘_’).”n”;<br />}<br />var_dump($datas);<br />?&gt;</span></p><div><span class="code"><strong>php的缓冲器</strong>：</span></div><div><span class="code">有eaccelerator， apc， phpa，xcache，这个这个就不说了吧，搜索一堆一堆的，自己看啦，知道有这玩意就OK</span></div><p><span class="code"><strong>MYSQL缓存</strong>：</span></p><p>这也算非代码级的，经典的数据库就是用的这种方式，看下面的运行时间，0.09xxx之类的<br />我贴段根据蓝色那家伙修改后部分my.ini吧，2G的MYISAM表可以在0.05S左右，据说他前后改了有快一年</p><p>代码拷贝框<br /><textarea class="codeTextarea" style="width: 490px; height: 195px;" cols="53" rows="9">[client] …… default-character-set=gbk default-storage-engine=MYISAM max_connections=600 max_connect_errors=500 back_log=200 interactive_timeout=7200 query_cache_size=64M …… table_cache=512 …… myisam_max_sort_file_size=100G myisam_max_extra_sort_file_size=100G myisam_sort_buffer_size=128M key_buffer_size=1024M read_buffer_size=512M …… thread_concurrency=8</textarea><br />[Ctrl+A 全部选择 然后拷贝]</p><p><strong>基于反向代理的Web缓存:</strong></p><p>如Nginx，SQUID，mod_proxy(apache2以上又分为mod_proxy和mod_cache)<br />NGINX的例子</p><p>代码拷贝框<br /><textarea class="codeTextarea" style="width: 494px; height: 196px;" cols="54" rows="10">&lt;nginx.conf&gt; #user  nobody; worker_processes  4; error_log  logs/error.log crit; pid        logs/nginx.pid; worker_rlimit_nofile 10240; events {     use epoll;     worker_connections  51200; } http {     include       mime.types;     default_type  application/octet-stream;     sendfile    on;     keepalive_timeout 65;     tcp_nodelay on;     # server pool     upstream bspfrontsvr {             server 10.10.10.224:80   weight=1;             server 10.10.10.221:80   weight=1;     }         upstream bspimgsvr {             server 10.10.10.201:80   weight=1;     }         upstream bspstylesvr {             server 10.10.10.202:80   weight=1;     }         upstream bsphelpsvr {             server 10.10.10.204:80   weight=1;     }         upstream bspwsisvr {             server 10.10.10.203:80   weight=1;     }         upstream bspadminsvr {             server 10.10.10.222:80   weight=1;     }         upstream bspbuyersvr {             server 10.10.10.223:80   weight=1;     }         upstream bspsellersvr {             server 10.10.10.225:80   weight=1;     }     upstream  bsploginsvr  {             server 10.10.10.220:443  weight=1;     }     upstream  bspregistersvr  {             server 10.10.10.220:80  weight=1;     }     log_format  test_com  ‘$remote_addr – $remote_user [$time_local] “$request” ‘                              ‘$status $body_bytes_sent “$http_referer” “$http_user_agent” ‘;     #——————————————————————–     #img.test.com     server {         listen       10.10.10.230:80;         server_name  img.test.com;         location / {                         proxy_pass      http://bspimgsvr;                         include         proxy_setting.conf;         }         access_log  logs/img.log  test_com;     }         #style.test.com     server {         listen       10.10.10.230:80;         server_name  style.test.com;         location / {                         proxy_pass      http://bspstylesvr;                         include         proxy_setting.conf;         }         access_log  logs/style.log  test_com;     }             #help.test.com     server {         listen       10.10.10.230:80;         server_name  help.test.com;         location / {                         proxy_pass      http://bsphelpsvr;                         include         proxy_setting.conf;         }         access_log  logs/help.log  test_com;     }             #admin.test.com     server {         listen       10.10.10.230:80;         server_name  admin.test.com;         location / {                         proxy_pass      http://bspadminsvr;                         include         proxy_setting.conf;         }         access_log  logs/admin.log  test_com;     }         #buyer.test.com     server {         listen       10.10.10.230:80;         server_name  buyer.test.com;         location / {                         proxy_pass      http://bspbuyersvr;                         include         proxy_setting.conf;         }         access_log  logs/buyer.log  test_com;     }         #seller.test.com     server {         listen       10.10.10.230:80;         server_name  seller.test.com;         location / {                         proxy_pass      http://bspsellersvr;                         include         proxy_setting.conf;         }         access_log  logs/seller.log  test_com;     }     #wsi.test.com     server {         listen       10.10.10.230:80;         server_name  wsi.test.com;         location / {                         proxy_pass      http://bspwsisvr;                         include         proxy_setting.conf;         }         access_log  logs/wsi.log  test_com;     }     #www.test.com     server {         listen       10.10.10.230:80;         server_name  www.test.com   *.test.com;         location ~ ^/NginxStatus/ {             stub_status on;             access_log off;         }         location / {                         proxy_pass      http://bspfrontsvr;                         include         proxy_setting.conf;         }         access_log  logs/www.log  test_com;         error_page   500 502 503 504  /50x.html;         location = /50x.html {             root   html;         }     }       #login.test.com     server {         listen       10.10.10.230:443;         server_name  login.test.com;         ssl                  on;         ssl_certificate      cert.pem;         ssl_certificate_key  cert.key;         ssl_session_timeout  5m;         ssl_protocols  SSLv2 SSLv3 TLSv1;         ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;         ssl_prefer_server_ciphers   on;         location / {                         proxy_pass        https://bsploginsvr;                         include         proxy_setting.conf;         }         access_log  logs/login.log  test_com;     }     #login.test.com for register     server {         listen       10.10.10.230:80;         server_name  login.test.com;         location / {                         proxy_pass        http://bspregistersvr;                         include         proxy_setting.conf;         }            access_log  logs/register.log  test_com;     }       } &lt;conf/proxy_setting.conf&gt;                         proxy_redirect          off;                         proxy_set_header        Host $host;                         proxy_set_header        X-Real-IP $remote_addr;                         proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;                         client_max_body_size    10m;                         client_body_buffer_size 128k;                         proxy_connect_timeout   90;                         proxy_send_timeout      90;                         proxy_read_timeout      90;                         proxy_buffer_size       4k;                         proxy_buffers           4 32k;                         proxy_busy_buffers_size 64k;                         proxy_temp_file_write_size 64k;</textarea><br />[Ctrl+A 全部选择 然后拷贝]</p><p>mod_proxy的例子：</p><p><span class="code">&lt;VirtualHost *&gt;<br />ServerName www.zxsv.com<br />ServerAdmin admin@zxsv.com<br /># reverse proxy setting<br />ProxyPass / http://www.zxsv.com:8080/<br />ProxyPassReverse / http://www.zxsv.com:8080/<br /># cache dir root<br />CacheRoot “/var/www/proxy”<br /># max cache storage<br />CacheSize 50000000<br /># hour: every 4 hour<br />CacheGcInterval 4<br /># max page expire time: hour<br />CacheMaxExpire 240<br /># Expire time = (now – last_modified) * CacheLastModifiedFactor<br />CacheLastModifiedFactor 0.1<br /># defalt expire tag: hour<br />CacheDefaultExpire 1<br /># force complete after precent of content retrived: 60-90%<br />CacheForceCompletion 80<br />CustomLog /usr/local/apache/logs/dev_access_log combined<br />&lt;/VirtualHost&gt;</span></p><p>而SQUID的例子我就不说明了，这方面网上有写的太多，大家自己搜索一下</p><p><strong>DNS轮询</strong>：</p><p>BIND是一款开放源码的DNS服务器软件，这个要说起来就大了，自己搜索去，大家知道有这个东西就行了。<br />我知道的有chinacache等大站就是这样做的，说简单点就是多服务器啦，把同一个页面或文件缓存到不同的服务器上，按南北自动解析到相关的服务器中。</p></div></div><ul id="flip2" class="flip"><li>Older:<a href="http://sk2.com/post/225.html">PHP文件上传$_FILES数组error键各值含义说明</a></li></ul></div>
<div id="footer"><div><a rel="nofollow" class="admin" href="http://sk2.com/login"><small>ADMIN</small></a><address>&copy; 2010 <a href='http://sk2.com/'>blog.sk80.com</a></address></div></div></div></div><script type="text/javascript" src="http://sk2.com/include/js/resize.js"></script><script type="text/javascript">var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));</script><script type="text/javascript">try {var pageTracker = _gat._getTracker("UA-5695529-2");pageTracker._trackPageview();} catch(err) {}</script></body></html>

<script language="javascript" type="text/javascript" src="http://js.users.51.la/3688801.js"></script>
<noscript><a href="http://www.51.la/?3688801" target="_blank"><img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="http://img.users.51.la/3688801.asp" style="border:none" /></a></noscript>